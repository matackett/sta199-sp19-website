---
title: "Data Wrangling & Merge Conflicts"
author: "Dr. Maria Tackett"
date: "01.28.19"
output:
  xaringan::moon_reader:
    mathjax: "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_HTMLorMML"
    css: "sta199-slides.css"
    logo: img/sta199-sticker-icon.png
    lib_dir: libs
    nature: 
      highlightLines: true
      highlightStyle: github
      countIncrementalSlides: false
---

layout: true

<div class="my-footer">
<span>
<a href="http://datasciencebox.org" target="_blank">datasciencebox.org</a>
</span>
</div> 

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      dpi=300,
                      fig.height = 3,
                      fig.width = 5
)
```

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(emo)
library(tidyverse)
library(fontawesome)
library(magick)
library(dsbox)
```

---

## Announcements

- Writing Ex 1 Revision - due **today at 11:59p**

- Think of team name if you haven't already

---

class: center, middle

# Data Wrangling

---

## Bike crashes in NC 2007 - 2014

The dataset is in the **dsbox** package:

```{r load-data, eval=FALSE}
library(dsbox)
ncbikecrash
```

- The dataset contains all North Carolina bike crash data from 2007-2014. 
- Data downloaded on Sep 6, 2018.

---

### A Grammar of Data Manipulation

**dplyr** is based on the concepts of functions as verbs that manipulate data frames.

.pull-left[
![](img/02b/dplyr-part-of-tidyverse.png)
]

.pull-right[
.tiny[
- `filter`: pick rows matching criteria
- `slice`: pick rows using index(es)
- `select`: pick columns by name
- `pull`: grab a column as a vector
- `arrange`: reorder rows
]
]

---

### A Grammar of Data Manipulation

**dplyr** is based on the concepts of functions as verbs that manipulate data frames.

.pull-left[
![](img/02b/dplyr-part-of-tidyverse.png)
]

.pull-right[
.tiny[
- `mutate`: add new variables
- `distinct`: filter for unique rows
- `sample_n` / `sample_frac`: randomly sample rows
- `summarise`: reduce variables to values
- ... (many more)
]
]

---

## **dplyr** rules for functions

- First argument is *always* a data frame

- Subsequent arguments say what to do with that data frame

- Always return a data frame

- Don't modify in place

---

### `filter` to select rows

- One condition: 
    - for crashes in Durham County

```{r eval=FALSE}
ncbikecrash %>%
  filter(county == "Durham") 
```

- Many conditions: 
    - for crashes in Durham County where biker was 0-5 years old

```{r eval=FALSE}
ncbikecrash %>%
  filter(county == "Durham", bike_age_group == "0-5")
```

---

### `select` to select or exclude variables

- select variables (columns)

```{r eval=FALSE}
ncbikecrash %>%
  filter(county == "Durham", bike_age_group == "0-5") %>%
  select(locality, speed_limit)
```

- exclude variables 

```{r eval=FALSE}
ncbikecrash %>%
  select(-object_id)
```

- range of variables 

```{r eval=FALSE}
ncbikecrash %>%
  select(city:locality)
```

---

### `slice` for certain row numbers

- First five

```{r}
ncbikecrash %>%
  slice(1:5)
```


- Last five

```{r}
last_row <- nrow(ncbikecrash)
ncbikecrash %>%
  slice((last_row - 4):last_row)
```

---

### `pull` to extract a column as a vector

.small[
```{r}
ncbikecrash %>%
  slice(1:6) %>%
  pull(locality)
```
]

vs.

.small[
```{r}
ncbikecrash %>%
  slice(1:6) %>%
  select(locality)
```
]

---

### `sample_n` / `sample_frac` for a random sample

- `sample_n`: randomly sample 5 observations

.small[
```{r}
ncbikecrash_n5 <- ncbikecrash %>%
  sample_n(5, replace = FALSE)
dim(ncbikecrash_n5)
```
]

- `sample_frac`: randomly sample 20% of observations

.small[
```{r}
ncbikecrash_perc20 <-ncbikecrash %>%
  sample_frac(0.2, replace = FALSE)
dim(ncbikecrash_perc20)
```
]
---

### `distinct` to filter for unique rows

And `arrange` to order alphabetically

```{r}
ncbikecrash %>% 
  select(county, city) %>% 
  distinct() %>% 
  arrange(county, city)
```

---

### `summarise` to reduce variables to values

```{r}
ncbikecrash %>%
  summarise(avg_hr = mean(crash_hour))
```

---

### `group_by` to do calculations on groups

```{r}
ncbikecrash %>%
  group_by(hit_run) %>%
  summarise(avg_hr = mean(crash_hour))
```

---

### `count` observations in groups

```{r}
ncbikecrash %>%
  count(driver_alcohol_drugs)
```

---

### `mutate` to add new variables

.small[
```{r eval=FALSE}
ncbikecrash %>%
  mutate(driver_alcohol_drugs_simplified = case_when(
    driver_alcohol_drugs == "Missing"       ~ NA,
    str_detect(driver_alcohol_drugs, "Yes") ~ "Yes",
    TRUE                                    ~ "No"
  ))
```
]
---

### "Save" when you `mutate`

Most often when you define a new variable with `mutate` you'll also want to save the resulting data frame, often by writing over the original data frame.

```{r}
ncbikecrash <- ncbikecrash %>%
  mutate(driver_alcohol_drugs_simplified = case_when(
    str_detect(driver_alcohol_drugs, "Yes") ~ "Yes",
    TRUE                                    ~ driver_alcohol_drugs
  ))
```

---

### Check before you move on

```{r}
ncbikecrash %>% 
  count(driver_alcohol_drugs, driver_alcohol_drugs_simplified)
```

```{r}
ncbikecrash %>% 
  count(driver_alcohol_drugs_simplified)
```

---

## AE 04 - NC bike crashes

- Copy the NC Bike Crashes project on RStudio Cloud

- For each question you work on, set the `eval` chunk option to `TRUE` and knit

---

class: middle, center

## Merge Conflicts


--- 

class: center, middle

# What is a merge conflict?

---

## Merge conflicts

When two collaborators make changes to a file and push the file to their repo, 
git merges these two files.

```{r echo=FALSE, out.width=400, fig.align="center"}
knitr::include_graphics("img/02c/merge-no-conflict.png")
```

--

If these two files have conflicting content on the same line, git will produce a 
**merge conflict**.

```{r echo=FALSE, out.width=400, fig.align="center"}
knitr::include_graphics("img/02c/merge-conflict.png")
```

---

## Resolving merge conflicts

- Merge conflicts need to be resolved manually, as they require a human intervention

```{r echo=FALSE, out.width=800, fig.align="center"}
knitr::include_graphics("img/02c/merge-conflict-identifiers.png")
```

- To resolve the merge conflict
  - decide if you want to keep only your text or the text on GitHub or 
  incorporate changes from both texts
  - delete the conflict markers `<<<<<<<`, `=======`, `>>>>>>>` and make the 
  changes you want in the final merge

---

class: center, middle

# Application exercise

---

## <i class="fas fa-laptop"></i> AE 06 - Merge conflics

- Clone your assignment repo in RStudio Cloud (`ae-06-merge-conflicts-TEAMNAME`), 
and open the R Markdown file.
- Assign the numbers 1, 2, 3, and 4 to each of the team members.
- Take turns in completing the exercise, only one member at a time:
.midi[
- Member 1: Change the team name to your team name, knit, commit, push.
- Member 2: Change the team name to something else, knit, commit, push. You 
will get an error. Pull. Review the document with the merge conflict. Resolve 
the conflict with the preferred change. Commit and push.
- Member 3: Create a plot displaying the relationship between `price` and `carat`, 
controlling for `cut` of the diamonds (see next slide for the plot). Knit, 
commit, push. You will get an error, read it, and pull. No merge conflicts should 
occur. Now push.
- Member 4: Set the `alpha` level to `0.5`. Knit, commit, push. You will get 
an error. Pull. Review the document with the merge conflict. Clear the 
merge conflict by choosing the correct/preferred change. Commit, and push.
- All members: Pull, and observe the changes in your document.
]

---

class: middle

Plot for Member 3 to recreate (the others can help of course!):

- data: `diamonds`
- variables: `carat`, `price`, `cut`

```{r echo=FALSE}
ggplot(data = diamonds, aes(x = carat, y = price, color = cut)) +
  geom_point()
```

---

class: center, middle

# Review

---

.question[
What does the following message mean?
]

<br>

```{r echo=FALSE, out.width=800, fig.align="center"}
knitr::include_graphics("img/02c/merge-conflict-error.png")
```

---

.question[
What does the following message mean?
]

<br>

```{r echo=FALSE, out.width=800, fig.align="center"}
knitr::include_graphics("img/02c/merge-failed.png")
```

---

.question[
What does the following message mean?
]

<br>

```{r echo=FALSE, out.width=800, fig.align="center"}
knitr::include_graphics("img/02c/no-merge-conflict.png")
```

---

.question[
What does the following message mean?
]

<br>

```{r echo=FALSE, out.width=800, fig.align="center"}
knitr::include_graphics("img/02c/merge-made.png")
```

---

## Tips for collaborating via GitHub

- Always pull first before you start working.
- Commit, and push, often to minimize merge conflicts and/or to make merge conflicts easier to resolve.
- If you find yourself in a situation that is difficult to resolve, ask questions asap, don't let it linger and get bigger.

